<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrustOrScam Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --tg-bg: #0e1621; 
            --tg-secondary: #17212b; 
            --tg-text: #ffffff; 
            --trust-blue: #3390ec; 
            --scam-red: #ff595a; 
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: var(--tg-bg); 
            color: var(--tg-text); 
            margin: 0; padding: 0; padding-bottom: 80px; 
            overflow-x: hidden; 
        }
        
        .header { padding: 15px; background: var(--tg-secondary); display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .user-avatar { width: 45px; height: 45px; background: #2481cc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; }
        .info-btn { margin-left: auto; color: var(--trust-blue); font-size: 20px; cursor: pointer; }

        .notice-container { padding: 10px 15px; display: flex; flex-direction: column; gap: 8px; }
        .notice-top { background: rgba(51, 144, 236, 0.1); color: var(--trust-blue); padding: 12px; border-radius: 12px; font-size: 13px; border-left: 4px solid var(--trust-blue); line-height: 1.4; }
        .notice-alert { background: rgba(255, 89, 90, 0.1); color: var(--scam-red); padding: 12px; border-radius: 12px; font-size: 13px; border-left: 4px solid var(--scam-red); line-height: 1.4; }

        .search-area { padding: 10px 15px; }
        .search-box { background: var(--tg-secondary); border-radius: 12px; padding: 14px; display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
        .search-box input { background: none; border: none; color: white; width: 100%; outline: none; margin-left: 10px; font-size: 16px; }
        
        .slider-section { padding: 10px 0 25px 15px; }
        .slider-container { display: flex; overflow-x: auto; gap: 15px; padding-right: 15px; scrollbar-width: none; }
        .slider-container::-webkit-scrollbar { display: none; }
        
        /* Fixed Box UI */
        .box-card { 
            width: 160px; /* Fixed Width */
            min-width: 160px;
            background: var(--tg-secondary); 
            border-radius: 25px; 
            padding: 22px 12px; 
            text-align: center; 
            position: relative; 
            border-bottom: 4px solid transparent;
            transition: transform 0.2s;
            cursor: pointer;
            overflow: hidden;
        }
        .box-card:active { transform: scale(0.95); }

        .img-wrapper { 
            width: 95px; height: 95px; 
            border-radius: 22px; margin: 0 auto 12px; 
            overflow: hidden; background: rgba(255,255,255,0.03); 
            display: flex; align-items: center; justify-content: center; 
            border: 1px solid rgba(255,255,255,0.08); 
        }
        .img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Fixed Text Styles */
        .name { 
            font-weight: bold; font-size: 16px; 
            display: flex; align-items: center; justify-content: center; gap: 5px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .verified-badge { color: #00a2ff; font-size: 15px; position: relative; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .verified-badge .fa-check { position: absolute; font-size: 7px; color: white; }

        .id-text { 
            font-size: 12px; color: #708499; display: block; margin-top: 6px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            max-width: 100%;
        }
        
        .nav-menu { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--tg-secondary); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid rgba(255,255,255,0.05); z-index: 1000; }
        .nav-item { color: #708499; text-decoration: none; display: flex; flex-direction: column; align-items: center; font-size: 11px; gap: 4px; }
        .nav-item.active { color: var(--trust-blue); }
        .nav-item i { font-size: 20px; }
    </style>
</head>
<body>

    <div class="header">
        <div class="user-avatar" id="uInit">?</div>
        <div>
            <div id="uName" style="font-weight: bold; font-size: 15px;">Loading...</div>
            <div id="uId" style="font-size: 12px; color: #708499;">ID: 00000000</div>
        </div>
        <i class="fas fa-info-circle info-btn" onclick="window.location.href='about.html'"></i>
    </div>

    <div class="notice-container">
        <div class="notice-top" id="topNotice">Loading notice...</div>
        <div class="notice-alert" id="scamAlert">Loading alert...</div>
    </div>

    <div class="search-area">
        <div class="search-box">
            <i class="fas fa-search" style="color: #708499;"></i>
            <input type="text" id="searchInput" placeholder="ID, Name or Number..." oninput="fetchData()">
        </div>
    </div>

    <div class="slider-section">
        <div style="color:#708499; margin-bottom:12px; font-weight:bold; font-size:11px; letter-spacing: 1px; text-transform: uppercase;">Trusted Members</div>
        <div class="slider-container" id="trustList"></div>
    </div>

    <div class="slider-section">
        <div style="color:#ff595a; margin-bottom:12px; font-weight:bold; font-size:11px; letter-spacing: 1px; text-transform: uppercase;">Scammers</div>
        <div class="slider-container" id="scamList"></div>
    </div>

    <div class="nav-menu">
        <a href="index.html" class="nav-item active"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="report.html" class="nav-item"><i class="fas fa-plus-circle"></i><span>Report</span></a>
        <a href="history.html" class="nav-item"><i class="fas fa-history"></i><span>History</span></a>
        <a href="profile.html" class="nav-item"><i class="fas fa-user-circle"></i><span>Profile</span></a>
    </div>

    <script>
        const SB_URL = "https://detrmszrwyolybdecqxn.supabase.co"; 
        const SB_KEY = "sb_publishable_mi0X-fBPpa1-EPd8AkEdgQ_n3d4nr2F"; 
        const _supabase = supabase.createClient(SB_URL, SB_KEY);
        const tg = window.Telegram.WebApp;
        
        if(tg.initDataUnsafe.user) {
            const u = tg.initDataUnsafe.user;
            document.getElementById('uName').innerText = u.first_name + (u.last_name ? " " + u.last_name : "");
            document.getElementById('uId').innerText = "ID: " + u.id;
            document.getElementById('uInit').innerText = u.first_name.charAt(0).toUpperCase();
        }

        async function loadSettings() {
            const { data } = await _supabase.from('settings').select('*');
            if (data) {
                data.forEach(s => {
                    if (s.id === 'top_notice') document.getElementById('topNotice').innerText = s.content;
                    if (s.id === 'scam_alert') document.getElementById('scamAlert').innerText = s.content;
                });
            }
        }

        async function fetchData() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            let { data: posts } = await _supabase.from('posts').select('*').eq('status', 'approved');

            if (query && posts) {
                posts = posts.filter(p => 
                    (p.tg_id && p.tg_id.toLowerCase().includes(query)) || 
                    (p.name && p.name.toLowerCase().includes(query)) ||
                    (p.contact && p.contact.toLowerCase().includes(query))
                );
            }
            renderList(posts || []);
        }

        function viewDetails(id) {
            localStorage.setItem('view_post_id', id);
            window.location.href = 'details.html';
        }

        function renderList(posts) {
            const trustList = document.getElementById('trustList');
            const scamList = document.getElementById('scamList');
            trustList.innerHTML = scamList.innerHTML = '';

            if(posts.length === 0) {
                const emptyMsg = "<p style='color:#708499; font-size:12px; padding-left:15px;'>No results found.</p>";
                trustList.innerHTML = scamList.innerHTML = emptyMsg;
                return;
            }

            posts.forEach(item => {
                const isTrust = (item.type === 'trust');
                const verifiedIcon = `<span class="verified-badge"><i class="fas fa-certificate"></i><i class="fas fa-check"></i></span>`;
                
                // ১. আইডির ক্ষেত্রে কমা (,) থাকলে শুধু প্রথম আইডিটি আলাদা করা
                const firstId = item.tg_id.split(',')[0].trim();

                const card = `
                    <div class="box-card" style="border-bottom-color: ${isTrust ? '#3390ec' : '#ff595a'}" onclick="viewDetails('${item.id}')">
                        <div class="img-wrapper">
                            ${item.image_url ? `<img src="${item.image_url.split('\n')[0]}" onerror="this.src='https://ui-avatars.com/api/?name=${item.name}&background=random'">` : `<i class="fas ${isTrust ? 'fa-user-shield' : 'fa-skull-crossbones'}" style="color:${isTrust ? '#3390ec' : '#ff595a'}; font-size:40px;"></i>`}
                        </div>
                        <span class="name">${item.name} ${isTrust ? verifiedIcon : ''}</span>
                        <span class="id-text">${firstId}</span>
                    </div>
                `;
                if(isTrust) trustList.innerHTML += card;
                else scamList.innerHTML += card;
            });
        }

        window.onload = () => { loadSettings(); fetchData(); };
        tg.expand();
    </script>
</body>
</html>
